a
    лбB"]Лћ;  л│                   @   sЛџ   d dl Z d dlZd dlZd dlZd dlZd dlZd dlZd dlZd dlm	Z	 d dl
mZ d dlT d dl
mZmZ d dlmZ e┬аdлјZG dd	Рђъ d	e jЛЊZdS )
л╣    N)лфServerMaker)лфPort)лф*)лфsend_messageлфget_message)лфlogin_requiredлфserverc                       sb   e Zd ZdZeЛЊ ZРђА fddРђъZddРђъ ZddРђъ Zdd	Рђъ Z	d
dРђъ Z
edd
Рђъ ЛЊZddРђъ Z
ddРђъ ZРђА  ZS )лфMessageProcessoru%
    лаЛЏлАлЃлалЁлаЛЋлалєлалЁлаЛЋлаРёќ лаЛћла┬╗ла┬░лАлЃлАлЃ лАлЃла┬хлАлѓлалєла┬хлАлѓла┬░. лаЛЪлАлѓлаЛЉлалЁлаЛЉлаЛўла┬░ла┬хлАРђџ лАлЃлаЛЋламЉлаЛЉлалЁла┬хлалЁлаЛЉлАлЈ, лАлЃла┬╗лаЛЋлалєла┬░лАлѓлаЛЉ - лаЛЌла┬░лаЛћла┬хлАРђџлАРђ╣
    лаЛЋлАРђџ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџлаЛЋлалє, лаЛЋла┬▒лАлѓла┬░ла┬▒ла┬░лАРђџлАРђ╣лалєла┬░ла┬хлАРђџ лаЛЌлаЛЋлАлЃлАРђџлАЛЊлаЛЌла┬░лАлІлАРђ░лаЛЉла┬х лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлАлЈ.
    ла┬ала┬░ла┬▒лаЛЋлАРђџла┬░ла┬хлАРђџ лалє лаЛћла┬░лАРђАла┬хлАлЃлАРђџлалєла┬х лаЛЋлАРђџламЉла┬хла┬╗лАлілалЁлаЛЋлаЛќлаЛЋ лаЛЌлаЛЋлАРђџлаЛЋлаЛћла┬░.
    c                    sF   || _ || _|| _d | _g | _d | _d | _d| _tЛЊ | _	t
ЛЊ ┬алј  d S )NT)лфaddrлфportлфdatabaseлфsockлфclientsлфlisten_socketsлф
error_socketsлфrunningлфdictлфnamesлфsuperлф__init__)лфselfлфlisten_addressлфlisten_portr   ┬Елф	__class__┬Е ЛіP/home/su/Projects/GeekBrains/data-base-and-PyQt/lesson_7/practice/server/core.pyr      s    zMessageProcessor.__init__c                 C   s  | ┬а лј  | jЛњrz| j┬алј \}}W n ty4   Y n(0 t┬аd|Рђ║ Люлј |┬аdлј | j┬а	|лј g }g }g }z(| jrлІt
┬а
| j| jg dлј\}| _| _W n6 tyлќ } zt┬а
d|jРђ║ Люлј W Y d}~n
d}~0 0 |r|D ]@}z| ┬аt|ЛЊ|лј W qла ttjtfЛњy   | ┬а|лј Y qла0 qлаqdS )u2   лаЛџла┬хлАРђџлаЛЋламЉ лаЛЋлАлЃлалЁлаЛЋлалєлалЁлаЛЋлаРёќ лАРђалаЛЉлаЛћла┬╗ лаЛЌлаЛЋлАРђџлаЛЋлаЛћла┬░.u0   лалѕлАлЃлАРђџла┬░лалЁлаЛЋлалєла┬╗ла┬хлалЁлаЛЋ лАлЃлаЛЋла┬хламЉла┬хлалЁлаЛЉла┬х лАлЃ лаЛЪлаЛЎ л╣   r   u/   лаЛЏлАРѓглаЛЉла┬▒лаЛћла┬░ лАлѓла┬░ла┬▒лаЛЋлАРђџлАРђ╣ лАлЃ лАлЃлаЛЋлаЛћла┬хлАРђџла┬░лаЛўлаЛЉ: N)лфinit_socketr   r
   лфacceptлфOSErrorлфloggerлфinfoлф
settimeoutr   лфappendлфselectr   r   лфerrorлфerrnoлфprocess_client_messager   лфjsonлфJSONDecodeErrorлф	TypeErrorлф
remove_client)r   лфclientZclient_addressZ
recv_data_lstZ
send_data_lstZerr_lstлфerrZclient_with_messager   r   r   лфrun6   s6    
ЛЈ(ЛЈzMessageProcessor.runc                 C   s`   t ┬аd|┬алј Рђ║ dЛюлј | jD ]*}| j| |kr| j┬а|лј | j|=  qHq| j┬а|лј |┬алј  dS )uлЎ
        лаЛџла┬хлАРђџлаЛЋламЉ лаЛЋла┬▒лАлѓла┬░ла┬▒лаЛЋлАРђџлАРђАлаЛЉлаЛћ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџла┬░ лАлЃ лаЛћлаЛЋлАРђџлаЛЋлАлѓлАРђ╣лаЛў лаЛЌлАлѓла┬хлАлѓлалєла┬░лалЁла┬░ лАлЃлалєлАлЈла┬илАлі.
        ла┬ўлАРђ░ла┬хлАРђџ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџла┬░ лаЛЉ лАЛЊламЉла┬░ла┬╗лАлЈла┬хлАРђџ ла┬хлаЛќлаЛЋ лаЛЉла┬и лАлЃлаЛЌлаЛЉлАлЃлаЛћлаЛЋлалє лаЛЉ ла┬▒ла┬░ла┬илАРђ╣:
        u
   лаЛЎла┬╗лаЛЉла┬хлалЁлАРђџ u*    лаЛЋлАРђџлаЛћла┬╗лАлІлАРђАлаЛЉла┬╗лАлЃлАлЈ лаЛЋлАРђџ лАлЃла┬хлАлѓлалєла┬хлАлѓла┬░.N)	r!   r"   лфgetpeernamer   r   Zuser_logoutr   лфremoveлфclose)r   r-   лфnamer   r   r   r,   [   s    
zMessageProcessor.remove_clientc                 C   s^   t ┬аd| jРђ║ d| jРђ║ dЛюлј t┬аtjtjлј}|┬а| j| jfлј |┬аdлј || _	| j	┬а
tлј dS )u3   лаЛџла┬хлАРђџлаЛЋламЉ лаЛЉлалЁлаЛЉлАРђалаЛЉла┬░ла┬╗лаЛЉла┬ила┬░лАРђџлаЛЋлАлѓ лАлЃлаЛЋлаЛћла┬хлАРђџла┬░.uE   лаРђћла┬░лаЛЌлАЛЊлАРђ░ла┬хлалЁ лАлЃла┬хлАлѓлалєла┬хлАлѓ, лаЛЌлаЛЋлАлѓлАРђџ ламЉла┬╗лАлЈ лаЛЌлаЛЋламЉлаЛћла┬╗лАлІлАРђАла┬хлалЁлаЛЉлаРёќ: uQ    , ла┬░ламЉлАлѓла┬хлАлЃ лАлЃ лаЛћлаЛЋлАРђџлаЛЋлАлѓлаЛЋлаЛќлаЛЋ лаЛЌлАлѓлаЛЉлалЁлаЛЉлаЛўла┬░лАлІлАРђџлАлЃлАлЈ лаЛЌлаЛЋламЉлаЛћла┬╗лАлІлАРђАла┬хлалЁлаЛЉлАлЈ: ur   . лаРђблАлЃла┬╗лаЛЉ ла┬░ламЉлАлѓла┬хлАлЃ лалЁла┬х лАЛЊлаЛћла┬░ла┬ила┬░лалЁ, лаЛЌлАлѓлаЛЉлалЁлаЛЉлаЛўла┬░лАлІлАРђџлАлЃлАлЈ лАлЃлаЛЋла┬хламЉлаЛЉлалЁла┬хлалЁлаЛЉлАлЈ лАлЃ ла┬╗лАлІла┬▒лАРђ╣лАРђд ла┬░ламЉлАлѓла┬хлАлЃлаЛЋлалє.g      л░?N)r!   r"   r   r
   лфsocketлфAF_INETлфSOCK_STREAMлфbindr#   r
   лфlistenлфMAX_CONNECTIONS)r   Z	transportr   r   r   r   i   s    ЛЈ
zMessageProcessor.init_socketc                 C   sлХ   |t  | jv r~| j|t   | jv r~z8t| j|t   |ЛЊ t┬аd|t  Рђ║ d|t Рђ║ dЛюлј W qл▓ tyz   | ┬а|t  лј Y qл▓0 nd|t  | jv rлю| j|t   | jvrлюt┬а	d|t  Рђ║ dЛюлј | ┬а| j|t   лј nt┬а	d|t  Рђ║ dЛюлј dS )	uP
        лаЛџла┬хлАРђџлаЛЋламЉ лаЛЋлАРђџлаЛЌлАлѓла┬░лалєлаЛћлаЛЉ лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлАлЈ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџлАЛЊ.
        uA   лаЛЏлАРђџлаЛЌлАлѓла┬░лалєла┬╗ла┬хлалЁлаЛЋ лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉла┬х лаЛЌлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлІ u    лаЛЋлАРђџ лаЛЌлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлЈ лф.u   лалјлалєлАлЈла┬илАлі лАлЃ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџлаЛЋлаЛў ug    ла┬▒лАРђ╣ла┬╗ла┬░ лаЛЌлаЛЋлАРђџла┬хлАлѓлАлЈлалЁла┬░. лалјлаЛЋла┬хламЉлаЛЉлалЁла┬хлалЁлаЛЉла┬х ла┬ила┬░лаЛћлАлѓлАРђ╣лАРђџлаЛЋ, ламЉлаЛЋлАлЃлАРђџла┬░лалєлаЛћла┬░ лалЁла┬хлалєлаЛЋла┬илаЛўлаЛЋла┬ХлалЁла┬░.u   лаЛЪлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлі us    лалЁла┬х ла┬ила┬░лАлѓла┬хлаЛќлаЛЉлАлЃлАРђџлАлѓлаЛЉлАлѓлаЛЋлалєла┬░лалЁ лалЁла┬░ лАлЃла┬хлАлѓлалєла┬хлАлѓла┬х, лаЛЋлАРђџлаЛЌлАлѓла┬░лалєлаЛћла┬░ лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлАлЈ лалЁла┬хлалєлаЛЋла┬илаЛўлаЛЋла┬ХлалЁла┬░.N)
лфDESTINATIONr   r   r   r!   r"   лфSENDERr    r,   r&   )r   лфmessager   r   r   лфprocess_messagev   s$    ЛЈЛЈ"ЛЈЛЈz MessageProcessor.process_messagec                 C   sl  t ┬аd|Рђ║ Люлј t|v rD|t tkrDt|v rDt|v rD| ┬а||лј Лњn$t|v Лњr(|t tkЛњr(t|v Лњr(t|v Лњr(t	|v Лњr(t
|v Лњr(| j|t	  |kЛњr(|t | jv rЛё| j┬а
|t	 |t лј | ┬а
|лј zt|tЛЊ W n tyЛђ   | ┬а|лј Y n0 n0t}d|t< zt||ЛЊ W n tЛњy"   Y n0 dS t|v Лњrl|t tkЛњrlt|v Лњrl| j|t  |kЛњrl| ┬а|лј ЛњnЛїt|v Лњrл╝|t tkЛњrл╝t|v Лњrл╝| j|t  |kЛњrл╝t}| j┬а|t лј|t< zt||ЛЊ W n tЛњyлХ   | ┬а|лј Y n0 Лњn|t|v Лњrt|t tkЛњrtt|v Лњrtt|v Лњrt| j|t  |kЛњrt| j┬а|t |t лј zt|tЛЊ W n tЛњyn   | ┬а|лј Y n0 ЛњnЛёt|v ЛњrЛї|t tkЛњrЛїt|v ЛњrЛїt|v ЛњrЛї| j|t  |kЛњrЛї| j┬а|t |t лј zt|tЛЊ W n tЛњyЛє   | ┬а|лј Y n0 Лњnlt|v Лњr~|t tkЛњr~t|v Лњr~| j|t  |kЛњr~t}ddРђъ | j┬алј D ЛЊ|t< zt||ЛЊ W n tЛњyz   | ┬а|лј Y n0 nл║t|v Лњr.|t t kЛњr.t|v Лњr.t!}| j┬а"|t лј|t#< |t# ЛњrЛѓzt||ЛЊ W n tЛњyлЙ   | ┬а|лј Y n0 n:t}d|t< zt||ЛЊ W n tЛњy*   | ┬а|лј Y n0 n:t}d|t< zt||ЛЊ W n tЛњyf   | ┬а|лј Y n0 dS )uL   лаЛџла┬хлАРђџлаЛЋламЉ лаЛЋлАРђџла┬▒лАлѓла┬░ла┬▒лаЛЋлАРђџлАРђАлаЛЉлаЛћ лаЛЌлаЛЋлАлЃлАРђџлАЛЊлаЛЌла┬░лАлІлАРђ░лаЛЉлАРђд лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлаРёќ.u6   ла┬ала┬░ла┬ила┬▒лаЛЋлАлѓ лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлАлЈ лаЛЋлАРђџ лаЛћла┬╗лаЛЉла┬хлалЁлАРђџла┬░ : uQ   лаЛЪлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлі лалЁла┬х ла┬ила┬░лАлѓла┬хлаЛќлаЛЉлАлЃлАРђџлАлѓлаЛЉлАлѓлаЛЋлалєла┬░лалЁ лалЁла┬░ лАлЃла┬хлАлѓлалєла┬хлАлѓла┬х.Nc                 S   s   g | ]}|d  РђўqS )r   r   )лф.0лфuserr   r   r   лф
<listcomp>лю   s   ЛЈz;MessageProcessor.process_client_message.<locals>.<listcomp>uU   лаЛюла┬хлАРђџ лаЛЌлАЛЊла┬▒ла┬╗лаЛЉлАРђАлалЁлаЛЋлаЛќлаЛЋ лаЛћла┬╗лАлІлАРђАла┬░ ламЉла┬╗лАлЈ ламЉла┬░лалЁлалЁлаЛЋлаЛќлаЛЋ лаЛЌлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлЈu$   лаРђћла┬░лаЛЌлАлѓлаЛЋлАлЃ лалЁла┬хлаЛћлаЛЋлАлѓлАлѓла┬хлаЛћлАРђџла┬хлалЁ.)$r!   лфdebugлфACTIONлфPRESENCEлфTIMEлфUSERлф
autorize_userлфMESSAGEr;   r<   лфMESSAGE_TEXTr   r   r>   r   лфRESPONSE_200r    r,   лфRESPONSE_400лфERRORлфEXITлфACCOUNT_NAMEлфGET_CONTACTSлфRESPONSE_202лфget_contactsлф	LIST_INFOлфADD_CONTACTZadd_contactлфREMOVE_CONTACTZremove_contactлф
USERS_REQUESTZ
users_listлфPUBLIC_KEY_REQUESTлфRESPONSE_511Z
get_pubkeyлфDATA)r   r=   r-   лфresponser   r   r   r(   лЅ   s┬г    $,ЛЈЛЈЛЈЛЈ
"ЛЈ"ЛЈ,ЛЈ,ЛЈ"ЛЈЛЈ
"
z'MessageProcessor.process_client_messagec                 C   s&  |t  t | j┬алј v r\t}d|t< zt||ЛЊ W n tyB   Y n0 | j┬а	|лј |┬а
лј  Лњnлќ| j┬а|t  t лјs┬Хt}d|t< zt||ЛЊ W n tyЛџ   Y n0 | j┬а	|лј |┬а
лј  Лњnlt
}t┬аt┬аdлјлј}|┬аdлј|t< t┬а| j┬а|t  t лј|лј}|┬алј }zt||ЛЊ t|ЛЊ}W n tЛњy0   |┬а
лј  Y dS 0 t┬а|t лј}	t|v Лњrл«|t dkЛњrл«t┬а||	лјЛњrл«|| j|t  t < |┬алј \}
}zt|tЛЊ W n& tЛњyЛЉ   | ┬а|t  t лј Y n0 | j┬а|t  t |
||t  t  лј nDt}d|t< zt||ЛЊ W n tЛњy   Y n0 | j┬а	|лј |┬а
лј  dS )uR   лаЛџла┬хлАРђџлаЛЋламЉ лАлѓла┬хла┬░ла┬╗лаЛЉла┬илАЛЊлАлІлАРђ░лаЛЉлаРёќ ла┬░лалєлАРђџлаЛЋлАлѓлаЛЉла┬илАРђалаЛЉлАлІ лаЛЌлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗ла┬хлаРёќ.u4   ла┬ўлаЛўлАлЈ лаЛЌлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлЈ лАЛЊла┬Хла┬х ла┬ила┬░лалЁлАлЈлАРђџлаЛЋ.u=   лаЛЪлаЛЋла┬╗лАліла┬илаЛЋлалєла┬░лАРђџла┬хла┬╗лАлі лалЁла┬х ла┬ила┬░лАлѓла┬хлаЛќлаЛЉлАлЃлАРђџлАлѓлаЛЉлАлѓлаЛЋлалєла┬░лалЁ.л╣@   лфasciiNiЛЈ  u   лаЛюла┬хлалєла┬хлАлѓлалЁлАРђ╣лаРёќ лаЛЌла┬░лАлѓлаЛЋла┬╗лАлі.)!rF   rN   r   лфkeysrK   rL   r   r    r   r1   r2   r   Z
check_userrW   лфbinasciiZhexlifyлфosлфurandomлфdecoderX   лфhmacлфnewZget_hashлфdigestr   Z
a2b_base64лфRESPONSEZcompare_digestr0   rJ   r,   Z
user_loginлф
PUBLIC_KEY)r   r=   r
   rY   Zmessage_authZ
random_strлфhashrc   ZansZ
client_digestZ	client_ipZclient_portr   r   r   rG   л┐   st    
ЛЈЛЇ
ЛЈ

ЛїzMessageProcessor.autorize_userc              	   C   sH   | j D ]<}zt| j | tЛЊ W q ty@   | ┬а| j | лј Y q0 qdS )up   лаЛџла┬хлАРђџлаЛЋламЉ лАлѓла┬хла┬░ла┬╗лаЛЉла┬илАЛЊлАлІлАРђ░лаЛЉлаРёќ лаЛЋлАРђџлаЛЌлАлѓла┬░лалєлаЛћлаЛЉ лАлЃла┬хлАлѓлалєлаЛЉлАлЃлалЁлаЛЋлаЛќлаЛЋ лАлЃлаЛЋлаЛЋла┬▒лАРђ░ла┬хлалЁлаЛЉлАлЈ 205 лаЛћла┬╗лаЛЉла┬хлалЁлАРђџла┬░лаЛў.N)r   r   лфRESPONSE_205r    r,   )r   r-   r   r   r   лфservice_update_lists7  s
    
z%MessageProcessor.service_update_lists)лф__name__лф
__module__лф__qualname__лф__doc__r   r   r   r/   r,   r   r>   r   r(   rG   rh   лф
__classcell__r   r   r   r   r	      s   %

dHr	   )лф	threadingлфloggingr%   r4   r)   ra   r]   r^   Zcommon.metaclassesr   Zcommon.descryptorsr   лфcommon.variablesлфcommon.utilsr   r   лфcommon.decosr   лф	getLoggerr!   лфThreadr	   r   r   r   r   лф<module>   s   
